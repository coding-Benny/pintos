# 1-4. Priority SchedulingğŸ™‹

> ê³¼ì œë¥¼ ì‹œì‘í•˜ê¸° ì „ì— ê´€ë ¨ ê°œë… ì •ë¦¬ê°€ í•„ìš”í•˜ë‹¤ë©´ [ë¨¼ì €](https://medium.com/@benny._.lee/pintos-1-3-cpu-scheduling-7d85923bf2eb) ì½ê³  ì˜¤ì‹œë©´ ì¢‹ìŠµë‹ˆë‹¤ğŸ˜‰



# ğŸ¯ ê³¼ì œ ëª©í‘œ

ê¸°ë³¸ì ìœ¼ë¡œ ì œê³µë˜ëŠ” pintosì˜ ìŠ¤ì¼€ì¤„ëŸ¬ëŠ” Round-Robin(RR)ìœ¼ë¡œ êµ¬í˜„ë˜ì–´ ìˆë‹¤. ìš°ì„ ìˆœìœ„ë¥¼ ê³ ë ¤í•˜ì§€ ì•Šê¸° ë•Œë¬¸ì— ìŠ¤ë ˆë“œê°€ unblock ë˜ê±°ë‚˜ ìƒì„±ë  ë•Œ ë¬´ì¡°ê±´ `ready_list`ì˜ ë§¨ ë’¤ì— ì‚½ì…í•˜ê³  ì„ ì ì´ ë°œìƒí•˜ì§€ë„ ì•ŠëŠ”ë‹¤. ì´ë²ˆ ê³¼ì œëŠ” RRë¡œ êµ¬í˜„ëœ ê²ƒì„ **ìš°ì„ ìˆœìœ„ë¥¼ ê³ ë ¤í•˜ëŠ” Preemptive Priority Schedulingìœ¼ë¡œ ìˆ˜ì •**í•¨ìœ¼ë¡œì¨ ìƒˆë¡œìš´ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ê°€ í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ë³´ë‹¤ ë†’ë‹¤ë©´, ìƒˆë¡œìš´ ìŠ¤ë ˆë“œê°€ ì‹¤í–‰ ì¤‘ì¸ ìŠ¤ë ˆë“œë¥¼ ì„ ì í•˜ë„ë¡ í•œë‹¤.



# ğŸ‘©ğŸ»â€ğŸ’» êµ¬í˜„

1. ìŠ¤ë ˆë“œì˜ ìƒíƒœë¥¼ ê³ ë ¤í•  ë•Œì˜ ìˆœì„œë¥¼ ê³ ë ¤í•˜ì—¬ ì ‘ê·¼í•´ë³´ì. ì²« ë‹¨ê³„ëŠ” ì¤€ë¹„ ìƒíƒœë¡œ ìŠ¤ë ˆë“œê°€ ìƒì„±ëœ í›„ `ready_list`ì—ì„œ ìŠ¤ì¼€ì¤„ ë˜ê¸°ë¥¼ ê¸°ë‹¤ë¦°ë‹¤. ìƒˆë¡œ ìƒì„±ëœ ìŠ¤ë ˆë“œê°€ `ready_list`ì— ì‚½ì…ë  ë•Œ, í˜„ì¬ ì‹¤í–‰ ì¤‘ì¸ ìŠ¤ë ˆë“œë³´ë‹¤ ìš°ì„ ìˆœìœ„ê°€ ë†’ì„ ê²½ìš° `thread_yield()`ë¡œ ìš°ì„ ìˆœìœ„ê°€ ë†’ì€ ìŠ¤ë ˆë“œê°€ CPUë¥¼ ì„ ì í•˜ë„ë¡ `thread_create()`ì— ë‹¤ìŒê³¼ ê°™ì´ ì¶”ê°€í•œë‹¤.

   ```c
   /* pintos/src/threads/thread.c */
   
   tid_t
   thread_create (const char *name, int priority, thread_func *function, void *aux)
   {
     ...
     thread_unblock (t);
     
     /* ìƒì„±ëœ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ê°€ í˜„ì¬ ì‹¤í–‰ì¤‘ì¸ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ë³´ë‹¤ ë†’ë‹¤ë©´ CPUë¥¼ ì–‘ë³´ */
     if (priority > thread_get_priority ())
     {
       thread_yield ();
     }
     
     return tid;
   }
   ```

<iframe src="https://medium.com/media/c48dec40393cc9f61c045cda7116da22" allowfullscreen="" frameborder="0" height="385" width="680" title="pintos/src/threads/thread.c" class="s t u du ai" scrolling="auto" style="box-sizing: inherit; position: absolute; top: 0px; left: 0px; width: 680px; height: 385px;"></iframe>

2. ì•ì˜ ê³¼ì •ì—ì„œ ìš°ì„ ìˆœìœ„ê°€ ë‚®ì•„ `thread_yield()`ë¥¼ í†µí•´ ì–‘ë³´í•œ ìŠ¤ë ˆë“œëŠ” ì¤€ë¹„ ìƒíƒœê°€ ë˜ì–´ `ready_list`ì— ì‚½ì…ëœë‹¤. ê¸°ì¡´ì—ëŠ” `ready_list`ì— ì‚½ì…í•  ë•Œ `list_push_back()`ì„ í†µí•´ ë§¨ ë’¤ì— ì‚½ì…í•˜ëŠ” ë°©ì‹ì´ì—ˆì§€ë§Œ, ê³¼ì œì˜ ëª©í‘œì— ë”°ë¼ ìš°ì„ ìˆœìœ„ë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì‚½ì…í•˜ë„ë¡ ê¸°ë³¸ì ìœ¼ë¡œ ë‚´ì¥ëœ í•¨ìˆ˜ì¸ `list_insert_ordered()`ë¥¼ ì‚¬ìš©í•  ê²ƒì´ë‹¤. ë¨¼ì € í•´ë‹¹ í•¨ìˆ˜ê°€ ì–´ë–»ê²Œ ì§œì—¬ ìˆëŠ”ì§€ ì‚´í´ë³´ì.

   ```c
   /* pintos/src/lib/kernel/list.c */
   
   void
   list_insert_ordered (struct list *list, struct list_elem *elem,
                        list_less_func *less, void *aux)
   {
     struct list_elem *e;
   
     ASSERT (list != NULL);
     ASSERT (elem != NULL);
     ASSERT (less != NULL);
   
     for (e = list_begin (list); e != list_end (list); e = list_next (e))
       if (less (elem, e, aux))
         break;
     return list_insert (e, elem);
   }
   ```

   ì¸ìë¡œ ë¦¬ìŠ¤íŠ¸ì™€ ìš”ì†Œ, ê·¸ë¦¬ê³  ì •ë ¬ ë°©ì‹ì„ ê²°ì •í•˜ëŠ” í•¨ìˆ˜ ë“±ì„ ë°›ì•„ forë¬¸ì„ ëŒë©´ì„œ ì¸ìë¡œ ë°›ì€ ë¦¬ìŠ¤íŠ¸ì˜ ê°ê°ì˜ ìš”ì†Œì™€ ì¸ìë¡œ ë°›ì€ ìš”ì†Œë¥¼ ì •ë ¬ì˜ ê¸°ì¤€ì´ ë˜ëŠ” í•¨ìˆ˜ë¥¼ ê±°ì³ ì ì ˆí•œ ìœ„ì¹˜ì— ì‚½ì…í•˜ë„ë¡ í•˜ê³  ìˆë‹¤. ì´ë²ˆ ê³¼ì œì—ì„œì˜ ì •ë ¬ì˜ ê¸°ì¤€ì€ **ìš°ì„ ìˆœìœ„**ì´ë¯€ë¡œ ë‘ ì¸ìì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë¹„êµí•˜ì—¬ ì²« ë²ˆì§¸ ì¸ìê°€ ìš°ì„ ì´ë©´ `true`ë¥¼, ë‘ ë²ˆì§¸ ì¸ìê°€ ìš°ì„ ì´ë©´ `false`ë¥¼ ë°˜í™˜í•˜ëŠ” `cmp_priority()`ë¥¼ êµ¬í˜„í•œë‹¤.

   ```c
   /* pintos/src/threads/thread.c */
   
   bool
   cmp_priority (const struct list_elem *a_, const struct list_elem *b_, void* aux UNUSED)
   {
     /* list_insert_ordered() í•¨ìˆ˜ì—ì„œ ì‚¬ìš©í•  ì •ë ¬ ë°©ë²•ì„ ê²°ì • */
     return list_entry (a_, struct thread, elem)->priority > list_entry (b_, struct thread, elem)->priority;
   }
   ```

   ê·¸ë¦¬ê³  `list_insert_ordered()`ì˜ ì¸ìë¡œ `cmp_priority`ë¥¼ ë„£ëŠ”ë‹¤.

   ```c
   /* pintos/src/threads/thread.c */
   
   void
   thread_yield (void)
   {
     ...
     /* list_push_back() ì‚­ì œí•œ ë‹¤ìŒ,
        í˜„ì¬ ìŠ¤ë ˆë“œê°€ CPUë¥¼ ì–‘ë³´í•˜ê³  ready_listì— ì‚½ì…ë  ë•Œ ìš°ì„ ìˆœìœ„ ìˆœì„œë¡œ ì •ë ¬í•´ ì‚½ì…ë˜ë„ë¡ ìˆ˜ì • */
     list_insert_ordered (&ready_list, &cur->elem, cmp_priority, 0);
     ...
   }
   ```

   

3. block ìƒíƒœì˜ ìŠ¤ë ˆë“œê°€ unblock ë˜ì–´ `ready_list`ì— ì¶”ê°€ë  ë•Œì—ë„ ìš°ì„ ìˆœìœ„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ì‚½ì…ë˜ë„ë¡ ê¸°ì¡´ì˜ ë§¨ ë’¤ì— ì‚½ì…í•˜ë˜ `list_push_back()`ì„ ì‚­ì œí•˜ê³ , `list_insert_ordered()`ì„ ì‚¬ìš©í•œë‹¤.

   ```c
   /* pintos/src/threads/thread.c */
   
   void
   thread_unblock (struct thread *t)
   {
     ...
     /* list_push_back()ì„ ì§€ìš´ ë‹¤ìŒ,
        ìŠ¤ë ˆë“œê°€ unblock ë  ë•Œ ìš°ì„ ìˆœìœ„ ìˆœìœ¼ë¡œ ì •ë ¬í•˜ì—¬ ready_listì— ì‚½ì…ë˜ë„ë¡ ìˆ˜ì • */
     list_insert_ordered (&ready_list, &t->elem, cmp_priority, 0);
     ...
   }
   ```

   

4. ì´ì œ `ready_list`ì—ì„œ ìš°ì„ ìˆœìœ„ê°€ ê°€ì¥ ë†’ì€ ìŠ¤ë ˆë“œì™€ í˜„ì¬ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë¹„êµí•˜ì—¬ ìŠ¤ì¼€ì¤„ë§í•˜ëŠ” `test_max_priority()`ë¥¼ êµ¬í˜„í•œë‹¤.

   ```c
   /* pintos/src/threads/thread.c */
   
   void
   test_max_priority (void)
   {
     /* ready_listì—ì„œ ìš°ì„ ìˆœìœ„ê°€ ê°€ì¥ ë†’ì€ ìŠ¤ë ˆë“œì™€ í˜„ì¬ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë¹„êµí•´ ìŠ¤ì¼€ì¤„ë§ */
     if (!list_empty (&ready_list) && thread_current ()->priority < list_entry (list_front (&ready_list), struct thread, elem)->priority)
     {
       thread_yield ();
     }
   }
   ```



5. í˜„ì¬ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë³€ê²½í•˜ëŠ” `thread_set_priority()`ì—ì„œ ë³€ê²½ëœ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ CPUë¥¼ ì„ ì í•˜ë„ë¡ `test_max_priority()`ë¥¼ í˜¸ì¶œí•œë‹¤.

   ```c
   /* pintos/src/threads/thread.c */
   
   void
   thread_set_priority (int new_priority)
   {
     thread_current ()->priority = new_priority;
     
     /* ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ê°€ ë³€ê²½ë˜ì—ˆì„ ë•Œ ìš°ì„ ìˆœìœ„ì— ë”°ë¼ ì„ ì ë˜ë„ë¡ í•¨ */
     test_max_priority ();
   }  
   ```



6. ë§ˆì§€ë§‰ìœ¼ë¡œ êµ¬í˜„í•œ í•¨ìˆ˜ë“¤ì„ í—¤ë” íŒŒì¼ì— ì„ ì–¸í•œë‹¤.

   ```c
   /* pintos/src/threads/thread.h */
   
   /* í˜„ì¬ ìŠ¤ë ˆë“œì™€ ê°€ì¥ ë†’ì€ ìš°ì„ ìˆœìœ„ë¥¼ ê°€ì§„ ìŠ¤ë ˆë“œì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë¹„êµí•˜ì—¬ ìŠ¤ì¼€ì¤„ë§ */
   void test_max_priority (void);
   
   /* ì¸ìë¡œ ì£¼ì–´ì§„ ìŠ¤ë ˆë“œë“¤ì˜ ìš°ì„ ìˆœìœ„ë¥¼ ë¹„êµ */
   bool cmp_priority (const struct list_elem *a, const struct list_elem *b, void *aux UNUSED);
   ```



------

# ê²°ê³¼

```
/* pintos/src/threads */
umask 001
make clean
make
cd build
make check
```

`make check` ì‹œ êµ¬í˜„í•œ ê³¼ì œ ë‚´ìš©ì„ ì‹¤í–‰í•˜ë©° ì •ë‹µê³¼ ë¹„êµí•œ ê²°ê³¼ë¥¼ ì¶œë ¥í•  íŒŒì¼ì„ ìƒì„±í•˜ê³  ë³´ë ¤ë©´ ì½ê¸°ì™€ ì“°ê¸° ê¶Œí•œì´ í•„ìš”í•˜ë¯€ë¡œ `umask 001`ì„ í†µí•´ íŒŒì¼ ê¶Œí•œì„ ì„¤ì •í•˜ê³  ê²€ì‚¬í•˜ë©´ ë‹¤ìŒê³¼ ê°™ì´ ì„¸ í•­ëª©ì—ì„œ passëœ ê²°ê³¼ë¥¼ í™•ì¸í•  ìˆ˜ ìˆë‹¤.ğŸ˜†

> 2ì§„ìˆ˜ë¡œ í‘œí˜„í–ˆì„ ë•Œ, `chmod`ì™€ ë‹¬ë¦¬ `umask`ëŠ” 0ì´ ê¶Œí•œë¶€ì—¬ë¥¼ ì˜ë¯¸í•œë‹¤.

![Image for post](https://miro.medium.com/max/758/1*5qoZ5K14PzRscBXm9twC1Q.png)